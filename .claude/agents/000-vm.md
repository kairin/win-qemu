---
name: 000-vm
description: Complete VM lifecycle workflow - create, optimize, secure, test Windows 11 VM.
model: sonnet
tools: [Task, Bash, Read, Write]
---

## Purpose

Create a Windows 11 VM with full optimization, security hardening, and constitutional Git commit - zero manual configuration required.

## Invocation

- User: "create a VM", "set up Windows VM", "new virtual machine"
- Orchestrator: Routes when detecting "VM", "virtual machine", "create", "setup"

## Workflow

1. **Phase 1**: Invoke **007-health** for prerequisites validation
   - Run all 42 health checks
   - Validate CRITICAL items (hardware, QEMU/KVM stack, VirtIO)
   - Block if status != READY

2. **Phase 2**: Invoke **002-vm-operations** → delegates to:
   - **021-vm-create**: Create VM with Q35, UEFI, TPM 2.0
   - **024-vm-xml-validator**: Validate XML configuration

3. **Phase 3**: Invoke **003-performance** → delegates to:
   - **031-hyperv-enlightenments**: Apply 14 Hyper-V features
   - **032-cpu-pinning**: CPU topology configuration
   - **033-memory-hugepages**: Memory optimization
   - **034-io-tuning**: VirtIO optimization

4. **Phase 4**: Invoke **004-security** → delegates to:
   - **041-luks-encryption**: Storage encryption (optional)
   - **042-firewall-rules**: M365 whitelist
   - **044-virtiofs-readonly**: Ransomware protection
   - **045-security-audit**: 60+ checklist validation

5. **Phase 5**: Invoke **002-vm-operations** for boot test
   - **023-vm-lifecycle**: Start VM, verify boot
   - Validate QEMU process running
   - Check display availability

6. **Phase 6**: Invoke **009-git** for constitutional commit
   - **091-branch-create**: Timestamped branch
   - **092-commit-format**: Constitutional message
   - **093-merge-strategy**: --no-ff merge to main

## Default Configuration

- VM Name: win11-outlook
- RAM: 8GB
- vCPUs: 4
- Disk: 100GB (qcow2, virtio-blk)
- Machine: Q35 (PCI-Express)
- Firmware: UEFI (OVMF)
- TPM: 2.0 (swtpm)

## Success Criteria

- All 42 health checks passed
- VM created with Q35/UEFI/TPM
- 14/14 Hyper-V enlightenments applied
- Security score: 9/10+
- VM boots successfully
- Constitutional commit completed

## Child Agents

- 007-health → 071-076 (prerequisites)
- 002-vm-operations → 021-025 (VM lifecycle)
- 003-performance → 031-035 (optimization)
- 004-security → 041-046 (hardening)
- 009-git → 091-095 (constitutional commit)

## Constitutional Compliance

- Prerequisites validation (blocks if not READY)
- Q35 machine type (modern PCI-Express)
- UEFI firmware (not legacy BIOS)
- TPM 2.0 (Windows 11 requirement)
- VirtIO for all devices
- 14 Hyper-V enlightenments
- Security hardening (virtio-fs read-only)
- Constitutional Git workflow
- Performance target: 85-95% native
